# fasttext 성공?
[[24.03.26#fasttext]]
어제 신나게 설치 실패해서 고통 받던 그것.
정확하게 어떤 것으로 해결됐는지는 확실하지 않다.
다만
```
poetry add fasttext-wheel
```
이게 해결점이었던 것 같기도 하다.
이것에 c++ 버전을 잘 설치한 것까지 해서 에러를 해결할 수 있었던 것으로 생각된다. 
그래서 이건 다른 환경에서 다시 테스트 해볼 필요가 있다는 것만 짚어두고 가겠다. ![[Pasted image 20240327092322.png]]
일단은 잘 동작한다!
내가 도전해본 것들
- poetry에서 깃으로 설치
- pip로 설치
- wheel 설치
- gcc버전 명시해서 설치
	- 컴파일 위해 c++ 설치
- fasttext-wheel 설치

이 중에서 wheel은 그냥 설치가 가능했고, c++도 설치가 가능했다.
나머지는 전부 같은 에러를 띄웠다. 

# fasttext 활용
https://github.com/facebookresearch/fastText/issues/1065
![[Pasted image 20240327111954.png]]
겨우겨우 잘 받아서 활용을 해보려는데, 데이터를 제대로 디코딩하지 못하는 문제가 있었다.
위의 해결법으로 잘 해결이 가능했다.

![[Pasted image 20240327113415.png]]
확인해보니 모델이 잘 불러와졌다. 
이제는 이 모델을 저장하고 서버의 디스크에 할당한다. 
이후에는 이를 활용해 서버가 동작하게 하면 된다.


# 매칭 서버 구동
백엔드 팀원의 요청에 따라 매칭 로직을 구성하는 작업을 진행해보자.
활용할 매칭 요소.
1. 색깔 - 0.2
2. 위치 0. 3
3. 물품명 - 0.3
4. 설명 - .02
5. 날짜 0.1
이 중에서 내가 먼저 할 것은? 설명에 대해서 유사도 구하기


설명에 있는 것들을 일단 형태소 분석을 진행한다.
분석을 한 이후에는 fasttext에 우겨 넣어 임베딩을 구한다. 
![[Pasted image 20240327135914.png]]
물품명에 띄어쓰기가 들어가면 결과가 상당히 오묘해진다.
![[Pasted image 20240327140047.png]]
차라리 

# 서버 간 통신 문제 - PIKX
https://www.lesstif.com/java/java-pkix-path-building-failed-98926844.html
현재 서버에서 이러한 문제가 발생하고 있다.
정확하게 말하면 배포 서버 간 문제가 발생하고 있는지는 확인을 아직 하지 못했지만, 개발자의 로컬의 메인 서버와 원격의 배치 서버가 통신하지 못하고 있는 상황이다.
그 원인은 SSL과 관련되어 있다.
프록시 서버를 거치면 SSL이 자동으로 적용되는데, 이때 문제가 발생한다는 것이다.

문제는 ssl 인증서에 대해 jvm이 정보를 가지고 있지 않다는 것에 기인한다. 
신뢰할 수 없는 ssl이니까 받지 않겠다고 하는 격인데, 이를 해결하기 위해서는 jvm이 구동될 때 이를 신뢰할 수 있도록 해주면 된다.

이건 결국 서버에 위치한 jvm에 대해서도 같은 문제를 야기할 것이다.
일단 내 로컬에서 배치 서버로의 연결을 시도해보자.

![[Pasted image 20240327204915.png]]
백엔드 팀원의 도움으로 쉽게 로컬에 서버를 띄우는 것에 성공했고, 어떻게 에러가 뜨는지도 확인 가능했다. 그럼 이제부터는 인프라가 빛을 발할 시간이다. ![[Pasted image 20240327204904.png]]
차근히 진행해본다.
![[Pasted image 20240327205100.png]]
두번째 뜨는 값이 jvm에 넣어주어야할 인증서라고 한다.
```bash
keytool -exportcert -keystore jssecacerts -storepass changeit -file output.cert -alias lesstif.com-
```
이걸 실행해준다. 
접속하고자 하는 사이트의 인증서를 확인하고, 이걸 keytool을 통해 jvm에 이식해준다는 뜻으로 해석했다.
```bash
sudo  keytool -importcert -keystore ${JAVA_HOME}/lib/security/cacerts -storepass changeit -file output.cert -alias letsencrypt
```
이것까지 해주어야만 한다.
정확하게 위에서는 export를 시켰고, 그것을 java에 등록해주는 과정을 거치는 것이다.
![[Pasted image 20240327210156.png]]
JAVA_HOME이 변수에 등록되어 있지 않은 관계로 다음의 설정을 해주었다.
![[Pasted image 20240327210444.png]]
아잇 킹받게.. 그냥 영어로 해라..
![[Pasted image 20240327210914.png]]
![[Pasted image 20240327210921.png]]
성공한 것으로 보인다.

이제 이게 완료된 것이라면, 도커파일에도 이에 해당하는 수정을 해줄 필요가 있다.
그런데 여기에서는 대화형으로 설정을 했는데 이걸 어떻게 도커파일에 녹일 수 있을까?
https://cheershennah.tistory.com/143
결국 요지는, 인증서를 자알 받아와서 그것을 자바의 security 폴더에 녹여내는 것.


라고 생각하고 열심히 도전을 해봤지만, 일단 실패했다.
jre 환경 컨테이너를 사용하는데 여기에는 윈도우와 같은 경로가 존재하지 않았다. lib 어딨어..
security 디렉토리는 있는데 여기에 무슨 짓을 해야 하는 것일까.
![[Pasted image 20240327234741.png]]
안 된다고 해서 포기할 나는 아니다. 
그렇다면 no prompt 옵션으로 keystore에 올리는 작업을 자동화한다.
그러나 아직 해결은 되지 않았다. 제대로 keystore을 지정한 게 맞는 것일까?
자바를 실행할 때 환경변수를 전달하는 것이 가능하다.
그렇다면 그것으로 keystore 위치를 명시해보자.
```
java -Djavax.net.ssl.keyStore=/path/to/mykeystore.jks -Djavax.net.ssl.keyStorePassword=mypassword -jar myapplication.jar
```
이렇게 한다고 한다. 
흠.
문제는 그대로이다. 
실행에는 이슈가 없으나, 500이 계속 발생한다. 아무런 리스폰스도 오지 않는다.
이정도 되면 슬슬 코드에 문제가 있나 의심이 간다. 
이건 내일 확인해봐야 알 수 있을 것이다.

# 모델 구현
어제 물품명 기반을 끝냈고, 오늘은 색깔과 장소를 끝냈다. 

# 파이썬 재설치
![[Pasted image 20240328162207.png]]
로컬의 파이썬 버전 3.11이라 poetry 호환이 안 된 관계로, 다시 설치하는 과정.
기껏 conda와 파이썬을 지웠더니 이제는 poetry가 동작하지 않는다.
그래서 열심히 다 지우고, 컴퓨터 껐다 키고, 다시 poetry 설치해서 겨우 작동되게 만들었다.
그동안 다른 데이터 팀원이 내가 만든 코드를 깃에 이식하는 작업을 진행했다.
아무래도 나는 이제 매칭 서버를 띄우는 작업을 진행해야 해서 작업 분할을 이렇게 하는 게 맞다고 생각이 들었다.


https://meconomybiz.tistory.com/13
재밌어 보이는 걸 찾으면 참기가 힘들다 ㅎㅎ..
그렇지만 지금 시도해보지는 않겠다. 
할 시간이 일단 없다.

# 매칭 서버 세팅
매칭 서버 구동을 위해 해야 할 일
- 모델 파일 넣기
	- 7기가에 달하는 파일을 깃으로 관리할 수는 없다.
	- 직접 도커파일로 집어넣는다.
- 환경 변수 파일 넣기
	- 깃에 넣기에 민감한 파일을 넣어준다.
	- 마찬가지, 도커파일로 넣는다.

![[Pasted image 20240328213813.png]]
기본적인 설정은 완료된 것 같으나, 예상치 못한 문제가 하나 생겼다.
매번 매치 서버 파일이 변경되는데 그 아래에 7기가 파일 복사 명령어를 넣어뒀더니 매번 복사하고 앉아있다..
순서를 바꿔준다.
![[Pasted image 20240328215517.png]]
순서는 이제 이렇게 된다.
match 디렉토리가 매번 바뀌기 때문에 그 위에 모델 파일을 먼저 copy한다.
.env 파일은 크기도 작고 match 서버에 넣어주어야만 하기에 이후에 레이어가 쌓도록 냅뒀다.
poetry install도 match 디렉을 받고나서 가능하기에 이후에 실행한다. 
![[Pasted image 20240328215450.png]]
이렇게 파일을 바꾼 후 처음에는 시간이 조금 걸릴 수밖에 없다. 
그러나 다음부터는 모델 파일을 매번 복사하는 일은 일어나지 않을 것이다.
![[Pasted image 20240328215750.png]]
그나저나 의존성이 많아지니 poetry install도 시간이 많이 소요된다.

# 도커파일 버전 관리
![[Pasted image 20240328214644.png]]
시간이 많지 않아 조금 미뤄뒀던 일.
도커파일을 버전으로 관리하는 것!
다른 사람들은 도커 허브에 아예 등록을 하던데, 이는 보안 상 좋지 않다고 판단하고 로컬 환경에만 이미지를 가지고 있는 것으로 방향을 잡았다.
그런데 이미지를 일일히 번호를 붙여야 하는데 어떻게 할 것인가.
정석으로 하자면.. 깃에서 관리되는 태그를 통해서 진행하는 게 맞다고 생각하지만, 우리의 깃은 버전 관리를 위해 태그를 지정하지는 않은 관계로 대안을 마련했다.
젠킨스 빌드 넘버.
```
version: '3'
services:
  my-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: myapp:${JENKINS_BUILD_NUMBER}
```
위와 같은 방식으로 버전을 명시한다. 
위 변수는 빌드가 실행될 때 젠킨스 서버가 인식할 수 있도록 export한다.

지금 해야 할 것.
- 매칭 서버 api 연동시키기
	- 포스트맨으로 확인해보려고 하나 로그인이 불가
	- 직접 더미로 요청 날리는 것은 가능
	- 백엔드 팀원의 수정으로 로그인 가능해진 후, 확인해보았으나 매칭 서버까지 요청이 도달하지 못하고 있음
	- 다른 팀원의 요청에 대해서는 keyerror를 띄우는 상황
	  ![[Pasted image 20240328233437.png]]
	- 추가적으로 매칭 서버의 레스폰스 타입이 지정된 것과 다른 이슈도 존재
	- 
- 도커파일 버전 붙이기
	- 젠킨스 파이프라인 수정 필요
	- 도커 컴포즈는 매치 서버만 수정해봄
		- 테스트 필요
	- .env 파일에 젠킨스 빌드 넘버 넣기
	- 보류
- 매칭 서버 헬스체크 바뀐 거 확ㄴ인해보기
	- 보류

