# 오늘 할 일
- 개인 ssh 연결  가능하게 세팅하기
	- 각각의 ip주소를 알아야 하고, pub파일을 받아야 한다.
	-  pem파일을 받아야 하나??
- front 이슈 확인하기
	- 서비스 워커가 제대로 실행되지 않는 이슈 존재
	- 느징스 딴에서 설정해주는 게 필요하다고 함.
- 소나큐브 적용
	- 알아만 보기
	- sonarqube.ssafy.com이 있는데 이게 무엇인지 궁금핟
	- 이걸 적용할 여지가 있는가?
# 프론트 이슈 해결하기
## 첫번째 문제
프론트 pwa가 제대로 적용되지 않는 문제부터.
현재 우리 서버는 느징스를 띄우고 이 서버가 웹 서버 역할을 한다.
프록시 서버 느징스와 프론트 느징스.
프론트 느징스에서 문제가 발생하길래 느징스 설정파일을 건드리면서 추가적으로 알아보니, pwa는 https환경에서 작동한다고 했다. 
그래서 고민하다가 프록시 서버를 그 자체로 웹 서버로 활용하는 방안을 구상했다.
굳이 두 개의 느징스 서버가 띄워질 필요는 없다고 판단한 것이다. 어차피 정적파일만 던져주는데 뭐 얼마나 문제가 생기겠나, 싶었다.
그런데 막상 해보니까, 제대로 정적 파일을 못 던져주고 있다.

해결하기 위해 시도한 것은 다음과 같다.
- default_server를 443으로 변경
- /로케이션 블럭의 위치를 최하단으로 배치
아마 이것 중에서 해결된 것이 아닐까 한다. 확실하지는 않다.
## 두번째 문제
![[Pasted image 20240322105023.png]]
다음은 이 문제이다.
https://stackoverflow.com/questions/49566059/service-worker-registration-error-unsupported-mime-type-text-html?newreg=14c5570bc104463f913143c801cb99e0
이건 느징스 단에서 해결해야하는 이슈일 수도 있을 것 같다. 

![[Pasted image 20240322105725.png]]
이런 식으로 해서 서비스 워커에 접근할 때 느징스에서 설정을 해줄 수 있도록 한다. 

![[Pasted image 20240322105702.png]]
새로운 문제 발생!
오 ㅋㅋ

# 파이썬 서버 다루기
![[Pasted image 20240322125927.png]]
점점 알면 안 되는 영역에 다가가는 느낌. 아무튼..
gpu  서버에 파이썬 서버를 띄우고 운용할 수 있을 것이라 생각했다. 근데 포트가 일단 다 막혀있다. 
ssh 연결도 막혀있다. 그렇다면 어떻게 이 서버와 다른 서버가 통신할 수 있을까?

ㅋㅋㅋ
생각한 방법
1. 포트를 연다
	1. 이건 정말 말도 안 된다. 어느 미친 서버가 클라 맘대로 포트를 열어주냐?
	2. iptable, ufw 전부 불가능이다.
2. ssh를 사용해서 내부의 스크립트를 실행시키거나, 내부에서 curl을 날려서 파이썬 서버에 접촉한다.
	1. 문서를 보니까 ssh를 막아뒀다고 한다.
	2. 실제로도 게이트웨이를 세우고 있는 모양인데, 어떤 주소로 접속을 해야 하는지 알 수 없다.
3. 깃에다 내가 원하는 값을 올리고, 크론탭으로 매번 불러와서 실행해본다
	1. 크론탭은 보니까 사용이 가능한 것으로 보인다. 
	2. 24시간마다 프로세스가 종료된다고는 하는데, 크론탭은 내가 직접 실행만 시켜주면 되는 거 아니겠냐
4. 브라우저를 통해 터미널을 사용한다.
	1. 셀레니움? 크롤링을 하는데 활용하는 툴을 이용해 브라우저를 조작한다.
	2. 터미널을 브라우저로는 접근이 가능하니까 이런 방법은 사용 가능할 수도 있다.
	3. 근데 터미널은 실시간으로 입력을 받는 것 같으니 아무래도 웹 소켓을 활용하는 게 아닐까 하는데, 이것에 대해서도 조작을 할 수 있나?
사실 4번은 진짜 너무 돌아가는 것이라 생각한다. 브라우저를 거쳐서 하는 것은 진짜 최후의 방법이 아닐까.
일단 3번부터.
## 도전
![[Pasted image 20240322133850.png]]
일단 크론탭은 충분히 가능했다.
![[Pasted image 20240322133951.png]]
보다시피, 1분마다 ls가 실행되고 그 값이 로그로 쌓이는 중이다.
그렇다면 스크립트 파일로 잘 내가 원하는 명령어를 실행만 하면 되는 것이다. 

gpu서버로 ssh를 연결하는 것은 불가능하다.
그렇지만 gpu서버가 ssh를 쓰는 것도 불가능할까?
아니, 그냥 우리 깃을 매번 다운 받게만 해도 되긴 할 것이다. 
근데.. 이건 서버를 배포하는 것과 관련된 일이다.

실제 서비스될 때 실시간으로 매칭을 시켜주려면, 무슨 방법을 취해야만 하는가?
음. 일단 최소한 매칭은 바로바로 해줄 필요는 없다고 생각한다. 
그렇다면 이 방법은 충분히 유효할 수 있다. 
사진에 대해 값을 내려주는 것은 gpt가 할 몫이기 때문에 당장은 신경 쓸 필요가 없다.
물론 이것도 우리의 서버로 띄운다는 전략을 세우는 순간 문제는 바뀐다..

그런데 결국 문제는, 배치 서버가 매치 서버에 요청을 날릴 때마다 답을 주어야만 한다는 것이다.

서버 요청은 깃으로 받고, 응답은 다른 서버에 날리는 방식으로??
가능은 한데.. 현실적이냐..

# 엘라스틱 서치 메모리 줄이기
![[Pasted image 20240322152434.png]]
엘라스틱서치, 이 친구가 요망하다.
혼자 11기가에 해당하는 메모리를 잡아드시는 덕분에 우리 서버는 한번 터질 뻔했다. 
스왑 메모리 설정을 안 했더라면.. 휴

그래서 이를 해결하기 위해 방법들을 모색해보는 중
![[Pasted image 20240322152416.png]]
엘라스틱 서치는 api를 통한 동적 환경 설정 기능을 제공한다. 

https://inpa.tistory.com/entry/LINUX-%F0%9F%93%9A-CURL-%EB%AA%85%EB%A0%B9%EC%96%B4-%EC%82%AC%EC%9A%A9%EB%B2%95-%EB%8B%A4%EC%96%91%ED%95%9C-%EC%98%88%EC%A0%9C%EB%A1%9C-%EC%A0%95%EB%A6%AC#curl_http_%EB%A9%94%EC%84%9C%EB%93%9C
일단 curl로 각종  http 메서드 사용하는 방법부터.

이걸 사용하려고 했는데..
https://www.elastic.co/kr/blog/managing-and-troubleshooting-elasticsearch-memory
더 좋은 방법을 찾았다. 
그냥 단순하게 엘서가 실행되는 jvm의 메모리 크기를 제한 거는 것이다. 

![[Pasted image 20240322154312.png]]
이렇게 확 줄어들었다!
기존에는 매모리 사용량이 14기가에 달했기 때문에 파이썬 서버를 띄우는 것은 실질적으로 불가능한 선택지였다.
그러나 이제는 충분히 가능할 것 같다!

지금 아쉬운 점은 이번 프로젝트에는 시간이 없어서 프로메테우스를 설정하지 않았다는 것이다.
이걸 일일히 htop으로만 확인을 하고 있으려니까 화딱지가.. 어우
로그라도 남기면서 조금 확인하고 싶다. 
# 파이썬 서버 ec2에 구동하기
gpu 서버에 파이썬 서버를 구동하는 것은 실질적으로 좌절되었다. 
일단 gpu 서버를 지정된 형식에 맞게 사용하는 것이 아니기도 하고, 그렇게 할 수 있도록 방법이 잘 마련되어 있는 것도 아니었다. 
그래서 결국 엘라스틱 서치 사용량을 줄이고 파이썬 서버를 우리 서버에 구동하기로 한 것.
![[Pasted image 20240322160339.png]]
이런 문제가 발생했다.
파이썬 버전의 문제라는 것이다.
https://mattpy.tistory.com/entry/pyenv-poetry-%EC%A1%B0%ED%95%A9%EC%9C%BC%EB%A1%9C-%EB%8B%A4%EC%96%91%ED%95%9C-python-%EB%B2%84%EC%A0%84-%EA%B0%9C%EB%B0%9C%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1
처음 보는 것인데, pyenv라는 녀석이 있다. 이 녀석을 통해 쉽게 파이썬 버전 관리를 할 수 있는 것으로 보인다.
https://velog.io/@ohdowon064/Python-install-pyenv-in-ubuntu
이렇게 쉽게 할 수 있는 것으로 보인다!

간단하게 깃에서 설치하고 명령어를 PATH에 등록해준다.

![[Pasted image 20240322165506.png]]
아니.. 왜 파이썬 설치 쉽게 하려고 pyenv 쓰는 건데 이러면 대체 무슨 소용이냐.
![[Pasted image 20240322165744.png]]
일단 이것부터 받아보자

음. 해결법은 생각보다 훨씬 수월했다. 그냥 apt로 파이썬이 관리돼서 그냥 설치하면 된다;;
근데 생각을 해보니, 결국 이제 ec2 서버에 띄울 거면 컨테이너로 관리하면 돼서 이렇게 안 해도 된다;;
무쳐부라


# 프론트 파일 위치
초기 구상에서는 개발 환경과 배포 환경을 명확히 구분할 생각이었다.
비록 같은 호스트에서 사용하기는 하지만, 그것이 실제 서비스를 가정했을 때 적절하다고 판단했기 때문이다. 
개발은 개발 환경에 두어 어떤 일이 나도 상관 없지만, 배포 중인 환경은 에러가 나면 안 되기 때문에 정확하게 스프린트가 끝났을 때, 문제 없을 때 continuous delivery로 진행한다. 이것이 내 계획이었다. 
그러나 해보니까 서버의 메모리는 그만한 여력이 없는 것으로 보여서 결국 개발 환경이 배포 환경이 되도록 세팅을 바꾸게 됐다.

초기 프론트 배포 계획은 이러했다.
프론트 배포 환경은 프록시 서버이다. 프록시가 바로 정적 파일을 넘겨준다.
프론트 개발 환경은 /front로 올 때 접근할 수 있다. 

그러나 이제 계획이 변동됨에 따라 프론트는 그냥 80포트에서 확인 가능하게 바꾼다. 
이 방향에서 구체적으로 생각을 해보니 개발이 이루어질 때마다 scp나 볼륨 마운트를 하지 않는 이상 프록시 서버가 매번 재구동되어야만 한다. 
볼륨 마운트를 시켜도 크게 상관은 없기에 조금 고민은 했지만, 컨테이너 환경을 쓰는 이점 중 하나는 이미지가 완전한 애플리케이션을 담고 컨테이너 구동만 시켜도 런타임 환경에서 필수적으로 이행해야 할 세팅이 아닌 이상 컨테이너에 직접적으로 조작을 가하는 것은 바람직하지 않다는 것이 내 결론.

그렇기에 현재 계획은 이렇다.
80포트로 프론트를 접근할 수 있는 것은 변함없다.
그러나 프록시 서버는 그대로 프록시 역할을 수행한다. 
즉, 프론트 서버를 하나 띄우고 그 서버가 80포트, 443포트로 오는 모든 요청을 처리하는 것이다. 
이 방법은 기존에 짜놓은 세팅과 스크립트 코드를 재활용할 수 있다는 것에서도 큰 이점이 있다.
프록시 서버를 재구동할 필요도 없다는 것은 말할 것도 없다. 
또한 웹 서버에 변경이 생길 때 이상적인 이미지를 만들 수 있다는 것까지,.
![[Pasted image 20240322213841.png]]
이렇게 바꾸겠다는 것. 

# 젠킨스 파이프라인 에러

![[Pasted image 20240322220500.png]]
또 생전 처음 보는 에러가 발생했다.
구문 오류.
https://stackoverflow.com/questions/64607789/jenkinsfilepipeline-script-error-syntax-error-unterminated-quoted-string