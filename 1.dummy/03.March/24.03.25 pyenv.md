# 파이썬 서버 설치하기
ec2에 파이썬 서버 올리기.
생각보다 도커파일을 다루는 게 잘 안 된다
poetry의 명령어를 제대로 인식하지 못하는 문제도 있는 것으로 보인다.
![[Pasted image 20240325101409.png]]
이런 식으로 다루고 있는데, 아랫줄을 실행하면 manage.py가 없다고 나오고 윗줄을 실행하면 shell이 없다고 나온다.. 뭐 어쩌라는 건지;

해결책은 찾았다. copy를 할 때 디렉토리 단위로 가져오지 않아 안 속에 파일들이 흩뿌려진 게 화근이었다.
workdir를 루트로 바꾸자 문제는 해결됐다.
![[Pasted image 20240325103747.png]]
그러나 아직 문제는 남아있다.
컨테이너 안에 들어가서 파이썬 서버가 살아있는지 확인은 충분히 가능한데, 왜 ec2 밖에서는 요청이 들어가지 못하는 걸까?
문제를 해결해나가는 과정. 기본적으로 django는 로컬호스트의 요청만 받도록 되어 있어 모든 주소에서 올 수 있도록 풀어줘야 한다. 
![[Pasted image 20240325104320.png]]
그래도 문제는 남아있다. 이러면 allowed hosts를 또 풀어줘야 한다.
실제로는 백 서버로만 쓸 거니까 우리 주소만 적어주면 될 것이라 생각된다.
![[Pasted image 20240325112918.png]]
최종적으로 만든 도커파일은 이렇게 된다.
poetry를 넣어둔 도커 이미지가 따로 없어 이렇게 귀찮게 만들어야 하긴 하는데, 그래도 한번 쓰기만 하면 크게 어려운 점은 없다는 점이 또 장점.
비효율적으로 이미지가 쌓이는 것을 방지하기 위해 순서도 조정했다. 


# 파이썬 버전 변경
초기에는 gpu 서버를 활용하기로 마음을 먹었기 때문에 gpu에 깔린 파이썬 3.9를 활용할 생각이었다.
그러나 계획이 무산되고, gpt4의 기능을 사용하기 위해서 최소 3.10의 파이썬 버전을 사용해야 한다는 이야기를 들었다. 
그래서 버전을 변경하고 서버를 다시 구축할 계획을 세우는 중이다.

```bash
apt insall python3.9
```
간단하게 3.9버전은 다운 받을 수 있었으나, 아무래도 기본 패키지에서는 파이썬 3.12를 제공하지 않는 듯하다.

그렇다면 역시 pyenv를 다시 한번만 더 파보자.
![[Pasted image 20240325125907.png]]
이런 에러들이 자잘하게 뜨는데, 이것들을 위해 의존성 처리를 해줘야 하는 것들이 있는 모양이다. 
```bash
apt install libbz2-dev
```
하나씩 에러를 해결해나가보자. 
```
apt install -y build-essential libssl-dev zlib1g-dev \
libbz2-dev libreadline-dev libsqlite3-dev curl \
libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev
```
이미 다른 글들에서도 이러한 문제를 겪은 케이스가 존재하는 모양이다.
개인적으로 이렇게 의존성 문제가 많다면 이것은 pyenv를 만든 사람들이 잘 캐치를 하는 게 바람직할 것이라 생각한다.
https://github.com/pyenv/pyenv/wiki#suggested-build-environment
이렇게 깃헙 위키를 참고해서 의존되는 환경을 설치하는 것은 좋지 않은 것 같은데..
왜 이렇게 해둔 것일까? 여력이 된다면 제안을 해보고 싶다. 
![[Pasted image 20240325132443.png]]
심지어 제안한 것을 그대로 했는데도 문제가 발생한다.
다른 글에 있는 것으로 설치를 할 때 계속 의존성 문제가 발생했다.
실수로 공식 문서에 나온 의존성을 전부 설치하지 않은 것이다.
이렇게 전부 내가 직접 전부 깔도록 하는 것이 맞나 싶다. 
# 깃 훅 스크립트 오류
![[Pasted image 20240325135220.png]]
여태 몰랐는데, 이런 이슈가 존재했다. 다른 사람들은 다 잘 됐지만 리눅스 환경에서 개발하는 내게만 생기는 문제인 것으로 보인다.
아무튼 실행 권한을 추가한 후 푸시했다.
링크를 걸어두길 잘 한 게 .git 파일에서 수정을 해도 해당 내용이 바로 깃에서 추적이 가능했다.

# 파이썬 빌드?
https://blog.bespinglobal.com/post/python-%ED%8C%A8%ED%82%A4%EC%A7%80-%EA%B4%80%EB%A6%AC%EB%A5%BC-%EC%9C%84%ED%95%9C-poetry%EA%B0%80%EC%83%81%ED%99%98%EA%B2%BD%EA%B9%8C%EC%A7%80/
잘 몰랐는데 파이썬도 빌드가 가능하다고 한다. pycache에 저장되는 파일들이 바로 그러한 것인데, 아예 빌드를 해서 배포하는 것이 가능하다고.
특히 poetry가 좋은 점이 이렇게 파이썬 파일을 배포할 수 있도록 도와준다는 점이다.
그래서 이를 적용해서 젠킨스 파이프라인을 작성할까 하다가, 당장의 우선순위에서 밀린다는 생각에 그만뒀다.

나중에 시도해볼까, 생각만 남겨둔다.

# 텍스트 유사도 모델 조사
https://aiopen.etri.re.kr/serviceList
한국어 대해서 다양한 api를 제공하는 사이트
그러나 이 사이트는 다양한 단어들을 처리하지 못하고, 학습시킬 여지도 없다.

한국어 word2vec에 대한 모델이 조금 존재한다.
또 한국어 단어 유사도에 대한 모델도 조금은 있는 듯하다.

https://github.com/roboreport/doc2vec-api/?tab=readme-ov-file
한국어 doc2vec 깃헙. 직접 학습을 진행시켜야 할 것으로 보임

https://huggingface.co/blueapple8259/TinyKoWiki-v1
한글 위키로 학습을 진행한 모델

# SSE 에러 대응
https://baebalja.tistory.com/563
ec2에 위치한 서버가 sse를 제대로 대응하지 못하는 이슈가 있다. 정확한 원인은 파악되지 않지만, 서버에서만 문제가 되는 것으로 보아서는 nginx가 만드는 문제일 수도 있겠다는 생각에 알아보는 중이다.

https://seungtaek-overflow.tistory.com/10

https://kdev.ing/x-accel-buffering/
이게 현재 문제의 가장 핵심적인 해결책인 듯하다.
proxy 세팅에서 버퍼링이 걸리지 않도록 바로 응답을 돌려주는 것.
![[Pasted image 20240325204614.png]]
빙고!
프록시 버퍼링이 걸려 있어서 기다렸다가 보내는 설정이 기본값으로 되어있는데, 이것을 끄니까 즉각적으로 sse 설정이 이루어졌다.
```
proxy_read_timeout 24h;
```
아무 설정이 없으니 1분만 지나도 연결이 끊기는 이슈가 있었다.
이 설정을 통해 연결 시간을 조금 더 늘려주었다.
nginx 단에서 이 설정을 하기보다는, 주기적으로 백 서버가 빈 이벤트를 보내거나 프론트가 abort날 시 다시 요청을 하도록 하는 것도 괜찮을 것 같다.
다시 생각해보면 그건 너무 비효율적인 방식이라 그냥 nginx에서 연결 시간을 늘리는 것이 맞는 것 같다. 
# 허깅페이스 탐구
허깅페이스.
이전에는 있다는 존재 정도만 알고 제대로 사용해본 적이 없었다.
근데 보니까 꽤나 다양한 모델들이 이미 존재한다.
처음에 내가 생각했던 것은 word2vec.
가방과 백을 같은 것으로 인식하는 무언가가 필요했다.
실질적으로 같은 것을 나타내는 단어들을 동일한 것으로 치환하는 기능을 구현할 생각이다.
근데 분실물 관련 데이터들에 특화된 모델은 당연히 없는 관계로, 아무래도 fine tuning을 진행해야 할 것 같다.
그런 데이터는 분실물 api를 열심히 긁어 모으면 될 것이라 생각한다.
https://huggingface.co/smartmind/roberta-ko-small-tsdae
https://huggingface.co/facebook/fasttext-ko-vectors?text=apple
일단 내가 원하는 작업을 할 수 있는 모델을 최대한 찾아보자.

근데 내가 하고 싶은 작업을 먼저 조금 구체화시킬 필요가 있다.
습득물을 올리는 사람은 그림과 간단 설명만을 올린다.
이것이 분실물이 자세히 올리는 글과 매칭이 되도록 만들어야 한다.
분실물에서는 카테고리를 쓴다.
갤럭시 S23이라고 쓸 때는 텍스트로 작성할 것이다.
