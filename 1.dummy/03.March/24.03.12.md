# 새로운 전략 구상
- 하나의 도커 컴포즈로 모든 것을 관리할 수 있을 것 같다.

[[24.03.11 ec2, 클라우드 강의#배포 실습]]
이게 어제 생각이었다.
## 도커 컴포즈 파일 방식
1. 하나의 도커 컴포즈 파일을 만든다.
2. 이 파일에는 느징스 및 모든 컨테이너가 들어간다. 
3. 컨테이너가 run될 때 알아서 세팅을 바꿀 수 있도록 만든다.
4. 세팅할 파일은 쉘 스크립트로 작성
	1. 각 무중단 배포마다 스크립트를 작성해서 port.inc파일의 내용을 수정할 수 있도록 만든다.
	2. 이렇게 하면, 매번 느징스 컨테이너를 재실행시켜야 한다. 
	3. 그냥 내부에 exec을 활용해서 조작을 하는편이 좋겠다.
5. 느징스는 그렇게 하지만, 다른 무중단 배포를 할 컨테이너들은 두 개를 배치한다. 
	1. 이름을 알기 쉽게 하는 것이 좋을 것이다. 자신이 가진 포트 이름을 쓰는 것이 보기에는 편할 듯.
	
이렇게 컴포즈를 구성한다. 이걸 관리하는 것은 deploy.sh 파일이다.
## 배포 방식
1. deploy.sh를 만든다.
	1. 인자를 통해 누가 바뀌어야 하는지 파악한다.
	2. 바꿀 서버의 이름을 변수로 저장한다.
2. 누가 블루인지, 그린인지 파악한다.
	1. 이건 포트번호를 변수로 저장할 것이다. 
3. 그린을 세운다.
4. 느징스에 명령하여 그린을 가리키게 한다.
5. 헬스체크한다.
6. 블루를 내린다.

도커파일을 매번 새로 만드는 것은 어떨까? 도커파일을 이용해야 제대로 버전관리가 이루어질 것이다. 도커 버전은 어떻게 해야만 하는가?

https://scbyun.com/entry/%EB%8F%84%EC%BB%A4-%EC%BB%B4%ED%8F%AC%EC%A6%88-%ED%8C%8C%EC%9D%BC-%EB%B2%84%EC%A0%84docker-compose-file-versions
도커 컴포즈 파일 확인 방법ㅑ

# 실전 세팅
느징스 초기 설정은 됐다. 도커 컴포즈 한번에 작성하는 것도 일차적으로는 성공했다.
그런데 느징스로 젠킨스를 들어가려고 하니까 계속 404가 뜬다. 
이 이유삭 어떤 문제인지는 아직 확실치 않다. upstream을 안써서 생긴 문제라고 생각했는데 다시 보니 그냥 젠킨스 자체가 가진 문제일 수도 있겠다는 생각.
나중에 다시 해보자.
ssl은 ec2에 이미 들어있는 것으로 구축했다.
# 콘피그 서버 세우기
이제는 config 서버를 세울 차례이다. 
![[Pasted image 20240312164720.png]]
원래 생각은  jre를 제공하는 도커 허브 이미지를 그대로 사용할 생각이었다.
근데 이게 생각만큼 잘 되지 않았다. 
이리저리 고통받다가 알아낸 것은, CMD를 배열 형태로 만들 때 무조건 쌍따옴표로 구분해야한다는 것. 
그리고 `java`명령어를 없애고 작성해야 한다는 것. 
정말 어이가 없는 건 이런 것에 대한 명확한 설명이 없었다는 것이다. 예시라도 똑바로 작성해줬으면 좋으련만.

겨우 실행은 됐지만 아직도 문제가 남았다.![[Pasted image 20240312171049.png]]
대충 보자면, tmpdir이 없다는 것 같다.
이를 해결하기 위해서 도커파일 이중 빌드를 사용해보았다. 혹시 jre이미지에 /tmp가 없는 건 아닐까 하는 생각때문이었다.![[Pasted image 20240312171146.png]]
이렇게 작성을 해봤는데, 결국 에러는 잡히지 않았다.


https://code-machina.github.io/2019/09/02/Docker-Security-Hardening.html
도커 파일 권한과 관련된 문제로 보이기도 한다. 
