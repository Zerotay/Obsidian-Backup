# 새로운 전략 구상
- 하나의 도커 컴포즈로 모든 것을 관리할 수 있을 것 같다.

[[24.03.11 ec2, 클라우드 강의#배포 실습]]
이게 어제 생각이었다.
## 도커 컴포즈 파일 방식
1. 하나의 도커 컴포즈 파일을 만든다.
2. 이 파일에는 느징스 및 모든 컨테이너가 들어간다. 
3. 컨테이너가 run될 때 알아서 세팅을 바꿀 수 있도록 만든다.
4. 세팅할 파일은 쉘 스크립트로 작성
	1. 각 무중단 배포마다 스크립트를 작성해서 port.inc파일의 내용을 수정할 수 있도록 만든다.
	2. 이렇게 하면, 매번 느징스 컨테이너를 재실행시켜야 한다. 
	3. 그냥 내부에 exec을 활용해서 조작을 하는편이 좋겠다.
5. 느징스는 그렇게 하지만, 다른 무중단 배포를 할 컨테이너들은 두 개를 배치한다. 
	1. 이름을 알기 쉽게 하는 것이 좋을 것이다. 자신이 가진 포트 이름을 쓰는 것이 보기에는 편할 듯.
	
이렇게 컴포즈를 구성한다. 이걸 관리하는 것은 deploy.sh 파일이다.
## 배포 방식
1. deploy.sh를 만든다.
	1. 인자를 통해 누가 바뀌어야 하는지 파악한다.
	2. 바꿀 서버의 이름을 변수로 저장한다.
2. 누가 블루인지, 그린인지 파악한다.
	1. 이건 포트번호를 변수로 저장할 것이다. 
3. 그린을 세운다.
4. 느징스에 명령하여 그린을 가리키게 한다.
5. 헬스체크한다.
6. 블루를 내린다.

도커파일을 매번 새로 만드는 것은 어떨까? 도커파일을 이용해야 제대로 버전관리가 이루어질 것이다. 도커 버전은 어떻게 해야만 하는가?

https://scbyun.com/entry/%EB%8F%84%EC%BB%A4-%EC%BB%B4%ED%8F%AC%EC%A6%88-%ED%8C%8C%EC%9D%BC-%EB%B2%84%EC%A0%84docker-compose-file-versions
도커 컴포즈 파일 확인 방법