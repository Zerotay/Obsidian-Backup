---
tags:
  - diary
  - architecture
  - docker
  - nginx
---
# 새로운 전략 구상
- 하나의 도커 컴포즈로 모든 것을 관리할 수 있을 것 같다.

[[24.03.11 ec2, 클라우드 강의#배포 실습]]
이게 어제 생각이었다.
## 도커 컴포즈 파일 방식
1. 하나의 도커 컴포즈 파일을 만든다.
2. 이 파일에는 느징스 및 모든 컨테이너가 들어간다. 
3. 컨테이너가 run될 때 알아서 세팅을 바꿀 수 있도록 만든다.
4. 세팅할 파일은 쉘 스크립트로 작성
	1. 각 무중단 배포마다 스크립트를 작성해서 port.inc파일의 내용을 수정할 수 있도록 만든다.
	2. 이렇게 하면, 매번 느징스 컨테이너를 재실행시켜야 한다. 
	3. 그냥 내부에 exec을 활용해서 조작을 하는편이 좋겠다.
5. 느징스는 그렇게 하지만, 다른 무중단 배포를 할 컨테이너들은 두 개를 배치한다. 
	1. 이름을 알기 쉽게 하는 것이 좋을 것이다. 자신이 가진 포트 이름을 쓰는 것이 보기에는 편할 듯.
	
이렇게 컴포즈를 구성한다. 이걸 관리하는 것은 deploy.sh 파일이다.
## 배포 방식
1. deploy.sh를 만든다.
	1. 인자를 통해 누가 바뀌어야 하는지 파악한다.
	2. 바꿀 서버의 이름을 변수로 저장한다.
2. 누가 블루인지, 그린인지 파악한다.
	1. 이건 포트번호를 변수로 저장할 것이다. 
3. 그린을 세운다.
4. 도커 헬스체크로 잘 돌아가는지 확인.
5. 느징스에 명령하여 그린을 가리키게 한다.
6. 느징스를 거쳐서 헬스체크한다.
7. 블루를 내린다.

도커파일을 매번 새로 만드는 것은 어떨까? 도커파일을 이용해야 제대로 버전관리가 이루어질 것이다. 도커 버전은 어떻게 해야만 하는가?

https://scbyun.com/entry/%EB%8F%84%EC%BB%A4-%EC%BB%B4%ED%8F%AC%EC%A6%88-%ED%8C%8C%EC%9D%BC-%EB%B2%84%EC%A0%84docker-compose-file-versions
도커 컴포즈 파일 확인 방법ㅑ

# 실전 세팅
느징스 초기 설정은 됐다. 도커 컴포즈 한번에 작성하는 것도 일차적으로는 성공했다.
그런데 느징스로 젠킨스를 들어가려고 하니까 계속 404가 뜬다. 
이 이유삭 어떤 문제인지는 아직 확실치 않다. upstream을 안써서 생긴 문제라고 생각했는데 다시 보니 그냥 젠킨스 자체가 가진 문제일 수도 있겠다는 생각.
나중에 다시 해보자.
ssl은 ec2에 이미 들어있는 것으로 구축했다.
# 콘피그 서버 세우기
## 목표 설정
이제는 config 서버를 세울 차례이다. 
불필요한 메모리 소모를 막기 위해 가벼운 jre 이미지를 활용해 환경을 구축한다.
https://hub.docker.com/r/ubuntu/jre
최신까지 관리되고 있는 것으로 보이는 이미지.
## 컨테이너 사용방법
### 문제
![[Pasted image 20240312164720.png]]
생각만큼 잘 되지 않았다. 
RUN이나, CMD를 사용할 때 /bin/sh가 존재하지 않는다고 오류를 냈다.
정말 최소한으로 경량화를 시킨 것인지 기본적인 쉘 실행 명령도 존재하지 않는 모양이었다.
### 해결
이리저리 고통받다가 알아낸 것은, CMD를 배열 형태로 만들 때 무조건 쌍따옴표로 구분해야한다는 것. 
그리고 `java`명령어를 없애고 작성해야 한다는 것. 
정말 어이가 없는 건 이런 것에 대한 명확한 설명이 없었다는 것이다. 예시라도 똑바로 작성해줬으면 좋으련만.
## 톰캣 실행 시 활용되는 tmpdir
### 문제
겨우 실행은 됐지만 아직도 문제가 남았다.![[Pasted image 20240312171049.png]]
대충 보자면, tmpdir이 없다는 것 같다.
### 접근
- 도커파일 이중 빌드
	- 이미지에 tmp 디렉터리조차 없는 것은 아닐까?
	- 멀티 스테이지 빌드를 통해 tmp디렉터리만 가져오기
	![[Pasted image 20240312171146.png]]
	- 이렇게 작성을 해봤는데, 결국 에러는 잡히지 않았다.
- 실행권한 부여
	- tmp 디렉터리에 실행 권한이 잘못 걸려 있어서 톰캣이 활용하지 못하는 것일까?
	- https://code-machina.github.io/2019/09/02/Docker-Security-Hardening.html
		- 도커 컨테이너 실행 시 파일 시스템을 read only로 사용하게 하는 설정이 있다. 이를 완전히 풀어본다.
		- 해결되지 않음
	- 단순하게 chmod로 777을 부여해본다. 
		- 해결되지 않음
	- 톰캣이 tmp 디렉터리를 사용하지 않도록 해본다.
		- 파일을 받는데 있어서 활용된다는 것 같다. ![[Pasted image 20240312221502.png]]
		- 해결되지 않음

## 결론
해결하지 못했다. 
경량화는 분명히 중요하게 다뤄야 하는 이슈이나, 개발자들에게 개발 환경을 구축해주는 것보다 중요하지는 않기에 우선순위 상 다음으로 미룬다.
당장은 기본적인 환경이 구축된 리눅스 이미지에 jre를 직접 패키지 매니저로 설치하고 환경을 구축한다. 

# 회고 및 다짐
오늘 목표로 했던 느징스 서버 세우기는 완료했다. 
ssl 설정을 마쳤고, 프록시 패스도 간단하게 걸어뒀다. 
그러나 config 서버를 완전히 세워주지 못 했기 때문에 이를 내일 빠르게 해결할 예정이다.
